<!DOCTYPE html>
<html lang="en-us">
<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
 <title>Remaking Sacred, part 1: Introduction and textures </title>



<meta name="description" content="A blog for my various projects">


<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="robots" content="all,follow">
<meta name="googlebot" content="index,follow,snippet,archive">
<link rel="stylesheet" id="ct-tracks-google-fonts-css" href="//fonts.googleapis.com/css?family=Raleway%3A400%2C700&amp;subset=latin%2Clatin-ext&amp;ver=4.7.2" type="text/css" media="all">
<link rel="stylesheet" href="https://lordsk.github.io/css/font-awesome.min.css" type='text/css' media='all'>

<link href="https://lordsk.github.io/css/style.css" rel="stylesheet" id="theme-stylesheet" type='text/css' media='all'>

<link href="https://lordsk.github.io/css/custom.css" rel="stylesheet" type='text/css' media='all'>
<link rel="shortcut icon" href="https://lordsk.github.io/img/favicon.ico" type="image/x-icon">
<link rel="icon" href="https://lordsk.github.io/img/favicon.ico" type="image/x-icon">


</head>


<body class="post-template-default single single-post single-format-standard ct-body singular singular-post not-front standard">
  
  <div id="overflow-container" class="overflow-container">
    <a class="skip-content" href="#main">Skip to content</a>
    <header id="site-header" class="site-header" role="banner">
      <div class='top-navigation'>
        <div class='container'>

  <div id="menu-secondary" class="menu-container menu-secondary" role="navigation">
    <button id="toggle-secondary-navigation" class="toggle-secondary-navigation"><i class="fa fa-plus"></i></button>

    <div class="menu">

      <ul id="menu-secondary-items" class="menu-secondary-items">
        
        <li id="menu-item" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item">
          <a href="/categories/ai">AI</a>
        </li>
        
        <li id="menu-item" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item">
          <a href="/categories/resacred">Resacred</a>
        </li>
        

      </ul>

    </div>

  </div>


  <ul class="social-media-icons">


    

    

    
    <li>
      <a href="https://twitter.com/LordSk_" data-animate-hover="pulse" class="twitter" target="_blank">
        <i class="fa fa-twitter-square" title="twitter"></i>
        <span class="screen-reader-text">twitter</span>
      </a>
    </li>
    

    

    

    

    


    
    <li>
      <a href="https://github.com/LordSk" data-animate-hover="pulse" class="github" target="_blank">
        <i class="fa fa-github" title="github"></i>
        <span class="screen-reader-text">github</span>
      </a>
    </li>
    

  </ul></div>

      </div>

      <div class="container">
        <div id="title-info" class="title-info">
  <div id='site-title' class='site-title'>
    
    <a href="/"> LordSk&#39;s blog </a>
    </div>
  </div>
  <button id="toggle-navigation" class="toggle-navigation">
    <i class="fa fa-bars"></i>
  </button>

  <div id="menu-primary-tracks" class="menu-primary-tracks"></div>
  <div id="menu-primary" class="menu-container menu-primary" role="navigation">
    

    <div class="menu">
      <ul id="menu-primary-items" class="menu-primary-items">
        <li id="menu-item" class="menu-item menu-item-type-custom menu-item-object-custom current-menu-item current_page_item menu-item-home menu-item">
          <a href="/">Home</a>
        </li>

        
        
        
        
        <li id="menu-item" class="menu-item menu-item-type-post_type menu-item-object-page menu-item">
          <a href="/cv/">CV</a>
        </li>
        
        
        
        <li id="menu-item" class="menu-item menu-item-type-post_type menu-item-object-page menu-item">
          <a href="/contact/">Contact</a>
        </li>
        
        
      </ul>



    </div>

  </div>

      </div>
    </header>

    <div id="main" class="main" role="main">

      
  <div id="loop-container" class="loop-container">
    
    <div class="post type-post status-publish format-standard has-post-thumbnail hentry category-design tag-design tag-standard-2 tag-tagalicious tag-travel entry full-without-featured odd excerpt-1">

      <div class='featured-image lazy lazy-bg-image' data-background="https://i.imgur.com/nXHUcuK.jpg">
      </div>
      
        <div class="entry-meta">
          <span class="date">December 05</span>	<span> / </span>

          <span class="author">
            
            <a href="https://lordsk.github.io/" title="Posts by LordSk" rel="author">LordSk</a>
            
          </span>


          
          <span class="category">
            <span> / </span>

            <a href="/categories/Resacred">Resacred</a>
          </span>
          


        </div>
        <div class='entry-header'>
          <h1 class='entry-title'> Remaking Sacred, part 1: Introduction and textures</h1>
        </div>
        <div class="entry-container">
          <div class="entry-content">
            <article>
              

<h3 id="introduction">Introduction</h3>

<p><strong>Sacred</strong> is an old 2004 game, a RPG similar to Diablo. I remember getting it for free at the time, attached to my PC Gamer magazine. It was my first real RPG game I ever got my hands on, and it was amazing.
I have many great memories playing this game, overcoming difficult enemies, completing quests, and dropping loot! Oh the satisfaction.</p>

<p>The year is now 2017 and I wanted to revisit Sacred, many years later. You can actually buy the game on GOG right now and run it on Windows 10. However, the game did not age well. The resolution is locked to
1024x768, the framerate is very low (around &lt;20 fps) and has plenty of other issues. The game is still playable yes, but I wanted more. First thing that came to mind was hack a better resolution in.
Dynamically patching the game at launch, changing a few instructions to use my full monitor resolution, seems simple enough. Unfortunately the values 1024 / 768 are hard coded. Furthermore,
 <strong>Directx 7</strong> was the chosen graphics api at the time and today&rsquo;s documentation of it is scarce to say the least. The patch solution is then quite difficult.</p>

<p>Then came another thought. How hard would it be to make a modern version of Sacred? The game&rsquo;s content is already there, I would &ldquo;just&rdquo; use it differently.
So that&rsquo;s what I am attempting to do, knowing full well that I may never complete this huge endeavour. To reverse the game I am using a combination of <strong>x64dbg</strong> and <strong>IDA</strong>.
To build the game anew I am using <strong>C++</strong> and <strong>OpenGL</strong>.</p>

<p>Here is the <a href="https://github.com/LordSk/Resacred">repo</a> if you want to follow along.</p>

<h3 id="initial-goal">Initial goal</h3>

<p>I can&rsquo;t just start blindly engineering an engine from the ground up without knowing the full problem to solve first. So I&rsquo;ll set a small goal to achieve,
 one that&rsquo;ll help me further understand how Sacred data is utilized. Sacred is a 2D isometric open world game, the world map seems be made of a composition of tiles.
There are several ground levels (house floors for example) and caves / dungeons to go into. I will start with that, try to render a basic version of the wold map.</p>

<p>Here is the simplified <strong>TODO</strong> list:</p>

<ul>
<li>Read texture data from texture file(s)</li>
<li>Upload texture data to the GPU</li>
<li>Read map data</li>
<li>Draw tiles according to map data</li>
</ul>

<h3 id="texture-data">Texture data</h3>

<p><img src="https://i.imgur.com/R7CUnlT.png" alt="PAK folder" title="PAK folder" /></p>

<p>The textures are located in the <strong>texture.pak</strong> file. I won&rsquo;t bore you with the specifics of said file, it has a simple archive-type layout. A header, followed by file descriptions and raw file data.
The thing I immediately noticed was the .TGA extension used in most filenames, representing the TARGA image format. Now you don&rsquo;t typically want to store your game textures in such a format.
You want your own, to load it as fast as possible. So I tried the obvious thing, load the texture data directly to an opengl texture using the standard <em>RGBA8</em> (1 byte per channel) pixel format.
And it worked! For a few images. For <strong>type 6</strong> images precisely. The rest (which are all <strong>type 4</strong>) were noisy and incoherent. Usually when you mess up the GPU image format you can still
make out what the image is, but here all I got was noise.</p>

<p><img src="https://i.imgur.com/dqJJqxF.png" alt="Noise textures" title="Noise textures" /></p>

<p>This can mean two things, the upload data is wrong and points to who knows where in memory (meaning a bug in my program), or textures are compressed.
After a while I finally found the corresponding function in IDA, as well as a few references to a &ldquo;gzopen&rdquo; command.
The next logical step is to use <strong>zlib</strong> and try to decompress (or deflate) this noisy texture data. To my surprise, it worked on the first try.
The decompressed image format is ARGB 16 bit (4 bits per channel).</p>

<p><img src="https://i.imgur.com/82C7gmr.png" alt="16bit textures" title="16bit textures" /></p>

<p><img src="https://i.imgur.com/h343aSM.png" alt="16bit textures 2" title="16bit textures 2" /></p>

<h3 id="conclusion">Conclusion</h3>

<p>That&rsquo;s it for now! Next up, reading map data and rendering the open world in glorious 1080p!</p>

            </article>
          </div>
          
      <div class='entry-meta-bottom'>
        

  <div class="entry-categories"><p><span>Categories</span>
    
    <a href="/categories/ai" title="View all posts in AI">AI</a>
    <a href="/categories/resacred" title="View all posts in Resacred">Resacred</a>
  </p>
</div>



<div class="entry-tags"><p><span>Tags</span>
  

</p></div>	</div>

<div class="author-meta">

  <div class="author">
    <img alt='LordSk' src="https://www.gravatar.com/avatar/d41d8cd98f00b204e9800998ecf8427e?s=100&d=identicon" class='avatar avatar-72 photo' height='72' width='72'>

    <span>
      Written by:<a href="https://lordsk.github.io/" title="Posts by LordSk" rel="author">LordSk</a>        </span>
    </div>
    <div class="bio">
      
      <p></p>
      


      

    


  
  <a class="twitter" target="_blank"
  href="https://twitter.com/LordSk_">
  <i class="fa fa-twitter-square"
  title="twitter icon"></i>
</a>










<a class="github" target="_blank"
href="https://github.com/LordSk">
<i class="fa fa-github"
title="github icon"></i>
</a>


</div>
</div>

</div>
</div>

<section id="comments" class="comments">
  <div id="disqus_thread"></div>
<script>
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "lordskblog" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

  




</section>
</div>

 



    </div>

    <footer id="site-footer" class="site-footer" role="contentinfo">
	<h1>
    
    <a href=""> LordSk&#39;s blog </a>
    
	</h1>

			

		<div id="menu-footer" class="menu-container menu-footer" role="navigation">
		<div class="menu">

      <ul id="menu-footer-items" class="menu-footer-items">
        
        <li id="menu-item" class="menu-item menu-item-type-post_type menu-item-object-page menu-item"><a href="/">Home</a></li>
        
        <li id="menu-item" class="menu-item menu-item-type-post_type menu-item-object-page menu-item"><a href="/cv/">CV</a></li>
        
        <li id="menu-item" class="menu-item menu-item-type-post_type menu-item-object-page menu-item"><a href="/contact/">Contact</a></li>
        
</ul>

</div>	</div>

<ul class="social-media-icons">

        

        


        
        <li>
        <a href="https://twitter.com/LordSk_"  class="twitter" target="_blank">
            <i class="fa fa-twitter-square" title="twitter"></i>
            <span class="screen-reader-text">twitter</span>
        </a>
        </li>
        

        

        

        

        


        
        <li>
        <a href="https://github.com/LordSk"  class="github" target="_blank">
            <i class="fa fa-github" title="github"></i>
            <span class="screen-reader-text">github</span>
        </a>
        </li>
        
				</ul>	<div class="design-credit">
		
		<p>&copy; 2018 Thomas &lsquo;LordSk&rsquo; Leroy</p>
		
		<p>Nederburg Hugo Theme by <a href="https://appernetic.io">Appernetic</a>.</p>
		
	</div>
</footer>

  </div>
  <script src="https://lordsk.github.io/js/jquery.min.js"></script>
<script src="https://lordsk.github.io/js/jquerymigrate.js"></script>
<script src="https://lordsk.github.io/js/production.min.js"></script>

</body>
</html>
